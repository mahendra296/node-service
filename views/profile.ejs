<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - AlisterBank</title>
    <link rel="stylesheet" href="/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <%- include('header') %>

    <main>
      <section class="profile-section">
        <div class="section-container">
          <div class="profile-header">
            <div class="profile-avatar-large">
              <%= profileUser.name ? profileUser.name.charAt(0).toUpperCase() : 'U' %>
            </div>
            <div class="profile-info">
              <h1><%= profileUser.name %></h1>
              <p class="profile-email-row">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <%= profileUser.email %>
              </p>
              <p class="profile-member-since">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Member since <%= new Date(profileUser.createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) %>
              </p>
            </div>
          </div>

          <div class="profile-content">
            <div class="profile-card">
              <h3>Account Information</h3>
              <div class="profile-details">
                <div class="detail-row">
                  <span class="detail-label">Full Name</span>
                  <span class="detail-value"><%= profileUser.name %></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Email Address</span>
                  <span class="detail-value"><%= profileUser.email %></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Account ID</span>
                  <span class="detail-value">#<%= profileUser.id %></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Member Since</span>
                  <span class="detail-value"><%= new Date(profileUser.createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) %></span>
                </div>
              </div>
            </div>

            <div class="profile-card">
              <h3>Security</h3>
              <div class="profile-details">
                <div class="detail-row">
                  <span class="detail-label">Password</span>
                  <span class="detail-value">••••••••</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Two-Factor Auth</span>
                  <span class="detail-value status-inactive">Not Enabled</span>
                </div>
              </div>
            </div>

            <div class="profile-card">
              <h3>Email Verification</h3>
              <div class="profile-details">
                <div class="detail-row">
                  <span class="detail-label">Status</span>
                  <% if (profileUser.isEmailVerified) { %>
                    <span class="detail-value status-active">Verified</span>
                  <% } else { %>
                    <span class="detail-value status-inactive">Not Verified</span>
                  <% } %>
                </div>
                <% if (!profileUser.isEmailVerified) { %>
                <div class="verification-section" id="verification-section">
                  <div id="send-code-section">
                    <p class="verification-info">Verify your email to access all features including URL shortener.</p>
                    <button type="button" class="btn-primary" id="send-code-btn" onclick="sendVerificationCode()">
                      Send Verification Code
                    </button>
                  </div>
                  <div id="verify-code-section" style="display: none;">
                    <p class="verification-info">Enter the 6-digit code sent to your email.</p>
                    <div class="verification-input-group">
                      <input type="text" id="verification-code" maxlength="6" placeholder="000000" pattern="[0-9]*" inputmode="numeric" />
                      <button type="button" class="btn-primary" id="verify-btn" onclick="verifyEmailCode()">
                        Verify
                      </button>
                    </div>
                    <button type="button" class="btn-link" onclick="sendVerificationCode()">Resend Code</button>
                  </div>
                  <p id="verification-message" class="verification-message"></p>
                </div>
                <% } %>
              </div>
            </div>

            <div class="profile-card profile-card-full">
              <div class="session-header">
                <h3>Active Sessions (<%= sessions.length %>)</h3>
                <% if (sessions.length > 1) { %>
                <form action="/logout-all-devices" method="POST" class="logout-all-form">
                  <button type="submit" class="btn-outline btn-danger btn-sm">
                    Logout All Devices
                  </button>
                </form>
                <% } %>
              </div>
              <p class="session-info">Manage your active sessions across all devices. You can logout from individual devices or all devices at once.</p>

              <div class="sessions-list">
                <% sessions.forEach(function(session) { %>
                <div class="session-item <%= session.id === currentSessionId ? 'current-session' : '' %>">
                  <div class="session-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <% if (session.userAgent && session.userAgent.toLowerCase().includes('mobile')) { %>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                      <% } else { %>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                      <% } %>
                    </svg>
                  </div>
                  <div class="session-details">
                    <div class="session-device">
                      <%
                        let deviceName = 'Unknown Device';
                        if (session.userAgent) {
                          if (session.userAgent.includes('Windows')) deviceName = 'Windows PC';
                          else if (session.userAgent.includes('Mac')) deviceName = 'Mac';
                          else if (session.userAgent.includes('Linux')) deviceName = 'Linux';
                          else if (session.userAgent.includes('Android')) deviceName = 'Android Device';
                          else if (session.userAgent.includes('iPhone') || session.userAgent.includes('iPad')) deviceName = 'iOS Device';
                        }
                      %>
                      <%= deviceName %>
                      <% if (session.id === currentSessionId) { %>
                      <span class="current-badge">Current</span>
                      <% } %>
                    </div>
                    <div class="session-meta">
                      <span class="session-ip">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                        </svg>
                        <%= session.ip || 'Unknown IP' %>
                      </span>
                      <span class="session-date">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <%= new Date(session.createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
                      </span>
                    </div>
                  </div>
                  <div class="session-action">
                    <form action="/session/delete/<%= session.id %>" method="POST">
                      <button type="submit" class="btn-icon btn-icon-danger" title="<%= session.id === currentSessionId ? 'Logout (Current Device)' : 'Remove Session' %>">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                </div>
                <% }); %>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <%- include('footer') %>

    <script>
      async function sendVerificationCode() {
        const sendBtn = document.getElementById('send-code-btn');
        const message = document.getElementById('verification-message');

        if (sendBtn) {
          sendBtn.disabled = true;
          sendBtn.textContent = 'Sending...';
        }
        message.textContent = '';
        message.className = 'verification-message';

        try {
          const response = await fetch('/send-verification-code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const data = await response.json();

          if (data.success) {
            document.getElementById('send-code-section').style.display = 'none';
            document.getElementById('verify-code-section').style.display = 'block';
            message.textContent = 'Verification code sent to your email!';
            message.className = 'verification-message success';
          } else {
            message.textContent = data.message || 'Failed to send code';
            message.className = 'verification-message error';
            if (sendBtn) {
              sendBtn.disabled = false;
              sendBtn.textContent = 'Send Verification Code';
            }
          }
        } catch (error) {
          message.textContent = 'An error occurred. Please try again.';
          message.className = 'verification-message error';
          if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send Verification Code';
          }
        }
      }

      async function verifyEmailCode() {
        const code = document.getElementById('verification-code').value;
        const verifyBtn = document.getElementById('verify-btn');
        const message = document.getElementById('verification-message');

        if (!code || code.length !== 6) {
          message.textContent = 'Please enter a valid 6-digit code';
          message.className = 'verification-message error';
          return;
        }

        verifyBtn.disabled = true;
        verifyBtn.textContent = 'Verifying...';
        message.textContent = '';

        try {
          const response = await fetch('/verify-email', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code }),
          });

          const data = await response.json();

          if (data.success) {
            message.textContent = 'Email verified successfully! Refreshing...';
            message.className = 'verification-message success';
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } else {
            message.textContent = data.message || 'Invalid code';
            message.className = 'verification-message error';
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'Verify';
          }
        } catch (error) {
          message.textContent = 'An error occurred. Please try again.';
          message.className = 'verification-message error';
          verifyBtn.disabled = false;
          verifyBtn.textContent = 'Verify';
        }
      }

      // Auto-focus on verification code input when it appears
      document.getElementById('verification-code')?.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
      });
    </script>
  </body>
</html>
