<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - AlisterBank</title>
    <link rel="stylesheet" href="/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <%- include('../header') %>

    <main
      style="
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        background: var(--bg-secondary);
      "
    >
      <div class="auth-container">
        <section class="form-section active" id="resetPasswordForm">
          <h2>Reset Password</h2>
          <p>Enter your new password below</p>

          <% if (success && success.length > 0) { %>
          <div class="alert alert-success"><%= success[0] %></div>
          <% } %> <% if (error && error.length > 0) { %>
          <div class="alert alert-error"><%= error[0] %></div>
          <% } %>

          <div id="message-container"></div>

          <form id="resetPasswordFormElement">
            <input type="hidden" name="token" value="<%= token %>" />
            <input type="hidden" name="email" value="<%= email %>" />

            <div class="input-group">
              <label for="newPassword">New Password</label>
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                placeholder="Enter new password"
                required
              />
            </div>

            <div class="input-group">
              <label for="confirmPassword">Confirm New Password</label>
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                placeholder="Confirm new password"
                required
              />
            </div>

            <div
              id="password-error"
              class="alert alert-error"
              style="display: none"
            ></div>

            <button type="submit" class="btn" id="submitBtn">
              Reset Password
            </button>
          </form>

          <div class="switch-text">
            <a href="/login">Back to Login</a>
          </div>
        </section>

        <aside class="side-panel">
          <svg
            width="80"
            height="80"
            viewBox="0 0 40 40"
            fill="none"
            style="margin-bottom: 2rem"
          >
            <rect width="40" height="40" rx="8" fill="rgba(255,255,255,0.2)" />
            <path d="M20 8L32 14V18H8V14L20 8Z" fill="white" />
            <rect x="10" y="20" width="4" height="12" fill="white" />
            <rect x="18" y="20" width="4" height="12" fill="white" />
            <rect x="26" y="20" width="4" height="12" fill="white" />
            <rect x="8" y="32" width="24" height="3" fill="white" />
          </svg>
          <h3>Password Tips</h3>
          <p>
            Use at least 8 characters with a mix of letters, numbers, and
            symbols for a strong password.
          </p>
          <a href="/login" class="switch-btn">Back to Login</a>
        </aside>
      </div>
    </main>

    <%- include('../footer') %>

    <script>
      const form = document.getElementById("resetPasswordFormElement");
      const newPassword = document.getElementById("newPassword");
      const confirmPassword = document.getElementById("confirmPassword");
      const passwordError = document.getElementById("password-error");

      // Validate passwords match
      function validatePasswords() {
        if (newPassword.value !== confirmPassword.value) {
          passwordError.textContent = "Passwords do not match";
          passwordError.style.display = "block";
          return false;
        }
        passwordError.style.display = "none";
        return true;
      }

      confirmPassword.addEventListener("input", validatePasswords);
      newPassword.addEventListener("input", () => {
        if (confirmPassword.value) {
          validatePasswords();
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!validatePasswords()) {
          return;
        }

        const submitBtn = document.getElementById("submitBtn");
        const messageContainer = document.getElementById("message-container");

        submitBtn.disabled = true;
        submitBtn.textContent = "Resetting...";
        messageContainer.innerHTML = "";

        const formData = new FormData(form);
        const data = {
          token: formData.get("token"),
          email: formData.get("email"),
          newPassword: formData.get("newPassword"),
        };

        try {
          const response = await fetch("/reset-password", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            messageContainer.innerHTML =
              '<div class="alert alert-success">' + result.message + "</div>";
            setTimeout(() => {
              window.location.href = "/login";
            }, 2000);
          } else {
            messageContainer.innerHTML =
              '<div class="alert alert-error">' + result.message + "</div>";
          }
        } catch (error) {
          messageContainer.innerHTML =
            '<div class="alert alert-error">Something went wrong. Please try again.</div>';
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Reset Password";
        }
      });
    </script>
  </body>
</html>
